services:
  # PostgreSQL Test Database
  db-test:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: studiosync_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U test_user -d studiosync_test" ]
      interval: 5s
      timeout: 3s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster test DB

  redis-test:
    image: redis:7-alpine

  # MinIO for local S3 testing
  minio-test:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: test_minio_admin
      MINIO_ROOT_PASSWORD: test_minio_password
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Mailhog for SMTP testing
  mailhog-test:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI

  # Django Backend (Test Mode)
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        python manage.py migrate --noinput &&
        pytest --cov=apps --cov-report=html --cov-report=term
      "
    volumes:
      - ./backend:/app
      - ./test-results:/app/test-results
      - ./htmlcov:/app/htmlcov
    environment:
      DEBUG: "False"
      DATABASE_URL: postgresql://test_user:test_password@db-test:5432/studiosync_test
      REDIS_URL: redis://redis-test:6379/0
      SECRET_KEY: test-secret-key-do-not-use-in-production
      ALLOWED_HOSTS: localhost,127.0.0.1,backend-test
      # MinIO test configuration
      MINIO_ENDPOINT: minio-test:9000
      MINIO_ACCESS_KEY: test_minio_admin
      MINIO_SECRET_KEY: test_minio_password
      MINIO_BUCKET: test-bucket
      AWS_S3_ENDPOINT_URL: http://minio-test:9000
      # SMTP test configuration (Mailhog)
      EMAIL_HOST: mailhog-test
      EMAIL_PORT: 1025
      EMAIL_USE_TLS: "False"
      # Stripe test mode
      STRIPE_PUBLISHABLE_KEY: pk_test_dummy
      STRIPE_SECRET_KEY: sk_test_dummy
      STRIPE_WEBHOOK_SECRET: whsec_test_dummy
      # Seed data in secure mode
      SEED_SECURE_MODE: "true"
      SEED_ADMIN_PASSWORD: test_admin_secure_password_123
      SEED_TEACHER_PASSWORD: test_teacher_secure_password_123
      SEED_STUDENT_PASSWORD: test_student_secure_password_123
    depends_on:
      db-test:
        condition: service_healthy
      redis-test:
        condition: service_started
      minio-test:
        condition: service_healthy

  # Frontend tests (can be run separately)
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    command: npm run test
    volumes:
      - ./frontend:/app
      - frontend_test_node_modules:/app/node_modules
    environment:
      NEXT_PUBLIC_API_URL: http://backend-test:8000/api
      NODE_ENV: test
    depends_on:
      - backend-test

volumes:
  frontend_test_node_modules:
